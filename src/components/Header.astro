---
import '../styles/header.css';

// Get current page or section to determine active tab
const currentPath = Astro.url.pathname;

// Número configurable (usa PUBLIC_PHONE si está en .env, sino usa el valor por defecto)
const PHONE = import.meta.env.PUBLIC_PHONE ?? '+56 9 5478 7021';
const PHONE_HREF = PHONE.replace(/[^+\d+]/g, '');

// Determine which tab should be active based on current path
let activeTab = 'inicio';
if (currentPath === '/') {
    activeTab = 'inicio';
} else if (currentPath.startsWith('/servicios-preventivo') || currentPath.startsWith('/servicios-anticipado') || currentPath.startsWith('/servicios-accion-inmediata')) {
    activeTab = 'servicios';
} else if (currentPath.startsWith('/quienes-somos')) {
    activeTab = 'quienes-somos';
} else if (currentPath.startsWith('/faq')) {
    activeTab = 'faq';
} else if (currentPath.startsWith('/trabaja-con-nosotros')) {
    activeTab = 'trabaja-con-nosotros';
}
---

<header>
    <div class="nav-container">
        <!-- Logo and mobile slogan section -->
        <div class="logo-mobile-wrapper">
            <div class="logo-section">
                <a href="/">
                    <img src="/logo.png" alt="Stop CAE logo featuring bold red and black text with a stylized legal scale symbol, conveying professionalism and determination; the logo is set against a clean white background, evoking trust and support for students facing debt" class="logo hover-pulse">
                </a>
                <!-- Número de teléfono móvil -->
                <a href={`tel:${PHONE_HREF}`} class="mobile-phone-link" aria-label={`Llamar ${PHONE}`}>
                    <i class="fas fa-phone"></i>
                    <span class="mobile-phone-number">{PHONE}</span>
                </a>
                <!-- Menu toggle button -->
                <button class="menu-toggle" id="menu-toggle" aria-label="Toggle Menu">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <!-- Mobile-only slogan -->
            <p class="mobile-slogan">Transformamos tu deuda estudiantil en el impulso para tus próximos proyectos</p>
        </div>
        
        <!-- Header content next to logo -->
        <div class="header-content">
            <!-- First row with contact info -->
            <div class="header-top">
                <div class="contact-info">
                    <a href={`tel:${PHONE_HREF}`} class="phone-link" aria-label={`Llamar ${PHONE}`}>
                        <i class="fas fa-phone"></i>
                        <span class="call-text">Llámanos</span>
                        <span class="phone-number">{PHONE}</span>
                    </a>
                </div>
            </div>
            
            <!-- Second row with slogan (desktop only) -->
            <div class="header-middle">
                <p class="slogan">Transformamos tu deuda estudiantil en el impulso para tus próximos proyectos</p>
            </div>
            
            <!-- Third row with navigation -->
            <div class="header-bottom">
                <nav>
                    <ul class="nav-menu" id="nav-menu">
                        <li><a href="/" class={`nav-link animate-on-scroll fade-in-up ${activeTab === 'inicio' ? 'active' : ''}`} data-section="inicio">Inicio</a></li>
                        <li class="dropdown-container">
                            <a href="#" class={`nav-link dropdown-toggle animate-on-scroll fade-in-up ${activeTab === 'servicios' ? 'active' : ''}`} data-section="servicios">
                                Servicios
                                <i class="fas fa-chevron-down dropdown-icon"></i>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a href="/servicios-preventivo" class="dropdown-link">Antes de la demanda → Stop Preventivo</a></li>
                                <li><a href="/servicios-anticipado" class="dropdown-link">Demanda ya ingresada → Stop Anticipado</a></li>
                                <li><a href="/servicios-accion-inmediata" class="dropdown-link">Demanda ya notificada → Acción Legal Inmediata</a></li>
                            </ul>
                        </li>
                        <li><a href="/quienes-somos" class={`nav-link animate-on-scroll fade-in-up ${activeTab === 'quienes-somos' ? 'active' : ''}`} data-section="quienes-somos">Quienes Somos</a></li>
                        <li><a href="/faq" class={`nav-link animate-on-scroll fade-in-up ${activeTab === 'faq' ? 'active' : ''}`} data-section="faq">FAQ</a></li>
                        <li><a href="/trabaja-con-nosotros" class={`nav-link animate-on-scroll fade-in-up ${activeTab === 'trabaja-con-nosotros' ? 'active' : ''}`} data-section="trabaja-con-nosotros">Trabaja con Nosotros</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>

<style>
    /* Estilos para el wrapper del logo y slogan en móvil */
    .logo-mobile-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: all 0.3s ease;
    }
    
    /* Estilo mejorado para el número de teléfono móvil */
    .mobile-phone-link {
        display: none;
        color: #c0392b;
        text-decoration: none;
        font-weight: bold;
        font-size: 14px;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: auto;
        flex-shrink: 0;
    }
    
    /* Eliminada la animación del ícono */
    .mobile-phone-link i {
        font-size: 16px;
        /* animación eliminada */
        vertical-align: middle; /* Mejor alineación vertical */
    }
    
    .mobile-phone-number {
        vertical-align: middle; /* Alinear con el ícono */
        display: inline-flex;
        align-items: center;
    }
    
    /* Estilo mejorado para el teléfono en desktop */
    .contact-info .phone-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .contact-info i {
        /* animación eliminada */
        vertical-align: middle;
    }
    
    .contact-info .call-text,
    .contact-info .phone-number {
        vertical-align: middle;
    }
    
    /* Asegurar que el teléfono esté siempre visible y fijo al lado del logo */
    header.scrolled .mobile-phone-link {
        /* NO mostrar en desktop */
        display: none !important;
    }
    
    /* Asegurar que el menu toggle NO aparezca en desktop */
    header.scrolled .menu-toggle {
        display: none !important;
    }
    
    /* Añade esta regla específica para móvil */
    @media (max-width: 768px) {
        header.scrolled .mobile-phone-link {
            display: flex !important; /* Solo aplicar display: flex en móvil */
            transform: translateX(-50%) scale(0.95);
            animation: slideInPhone 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        header.scrolled .menu-toggle {
            display: block !important; /* Solo mostrar en móvil */
            animation: slideInToggle 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Evitar que el logo se encoja en móvil */
        header.scrolled .logo {
            max-width: 120px !important; /* Mantener el tamaño original del logo en móvil */
            animation: logoShrink 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Evitar que logo-mobile-wrapper se encoja */
        header.scrolled .logo-mobile-wrapper {
            padding: 10px !important; /* Mantener padding original */
            animation: wrapperCollapse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Desactivar las reglas problemáticas del header.css en móvil */
        header.scrolled .nav-container {
            flex-direction: column !important;
            align-items: flex-start !important;
            padding: 0 1rem !important;
            animation: containerCollapse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        header.scrolled .header-content {
            width: 100% !important;
        }
        
        /* Asegurar que header-top y header-middle sigan ocultos en móvil */
        header.scrolled .header-top,
        header.scrolled .header-middle {
            display: none !important;
            opacity: 0;
            transform: translateY(-20px);
        }
        
        /* Animación del slogan móvil cuando se oculta */
        header.scrolled .mobile-slogan {
            animation: sloganFadeOut 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Slogan para móvil (oculto por defecto) */
    .mobile-slogan {
        display: none;
        font-size: 14px;
        font-style: italic;
        color: #ffffffff;
        margin: 5px 0 0 0;
        max-width: 250px;
        text-align: center;
        line-height: 1.3;
        transition: all 0.3s ease;
        width: 100%;
    }
    
    /* Ocultar los lemas cuando el header está en estado scrolled */
    header.scrolled .mobile-slogan,
    header.scrolled .header-middle,
    header.scrolled .slogan {
        display: none;
        opacity: 0;
        height: 0;
        margin: 0;
        padding: 0;
        overflow: hidden;
        transform: translateY(-20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Animaciones para elementos del header cuando se hace scroll */
    header {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    header.scrolled .logo {
        max-width: 100px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        transform: scale(0.9);
    }
    
    /* Animaciones para elementos móviles */
    header.scrolled .mobile-phone-link {
        transform: translateX(-50%) scale(0.95);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    header.scrolled .menu-toggle {
        transform: scale(0.9);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Animaciones para el nav-container */
    header.scrolled .nav-container {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Animaciones para elementos del header-content */
    header.scrolled .header-top {
        opacity: 0;
        transform: translateY(-15px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Transiciones suaves para todos los elementos */
    .logo, .mobile-phone-link, .menu-toggle, .mobile-slogan,
    .header-top, .header-middle, .slogan, .nav-container {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Animaciones de entrada cuando el header no está scrolled */
    header:not(.scrolled) .mobile-slogan {
        animation: fadeIn 0.8s ease-in-out;
    }
    
    header:not(.scrolled) .header-top {
        animation: slideInFromTop 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    header:not(.scrolled) .header-middle {
        animation: slideInFromTop 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    header:not(.scrolled) .logo {
        animation: logoExpand 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Media queries para móvil */
    @media (max-width: 768px) {
        .logo-mobile-wrapper {
            width: 100%; /* Usar todo el ancho del nav-container */
        }
        
        .logo-section {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            position: relative;
        }
        
        .mobile-phone-link {
            display: flex;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
        }
        
        .logo {
            flex-shrink: 0;
            max-width: 120px;
        }
        
        .menu-toggle {
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .mobile-slogan {
            display: block;
            animation: fadeIn 0.8s ease-in-out;
            font-size: 14px;
        }
        
        .header-middle {
            display: none; /* Oculta el slogan en desktop */
        }
        
        .nav-container {
            flex-direction: column;
            align-items: flex-start;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Expandir el nav-container cuando el dropdown está activo */
        .nav-menu.active .dropdown-container.active {
            margin-bottom: 1.5rem;
        }
        
        /* Asegurar que el nav-container tenga espacio suficiente */
        .nav-menu.active .dropdown-container.active .nav-container {
            padding-bottom: 1.5rem;
            animation: navContainerExpand 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .logo-section {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    }

    /* Media queries para tablets (768px - 1024px) */
    @media (min-width: 769px) and (max-width: 1024px) {
        .logo {
            max-width: 130px;
        }
        
        .mobile-slogan {
            display: none;
        }
        
        .slogan {
            font-size: 15px;
        }
        
        .contact-info .phone-link {
            padding: 0.4rem 0.8rem;
            font-size: 0.95rem;
        }
        
        .nav-menu a {
            font-size: 0.85rem;
            padding: 0.5rem 0.4rem;
        }
        
        .nav-container {
            padding: 0 1.5rem;
        }
    }

    /* Media queries para pantallas grandes (1025px - 1440px) */
    @media (min-width: 1025px) and (max-width: 1440px) {
        .logo {
            max-width: 140px;
        }
        
        .slogan {
            font-size: 16px;
        }
        
        .contact-info .phone-link {
            padding: 0.5rem 1rem;
        }
        
        .nav-menu a {
            font-size: 0.9rem;
            padding: 0.6rem 0.5rem;
        }
    }

    /* Media queries para pantallas extra grandes (>1440px) */
    @media (min-width: 1441px) {
        .logo {
            max-width: 160px;
        }
        
        .slogan {
            font-size: 18px;
        }
        
        .contact-info .phone-link {
            padding: 0.6rem 1.2rem;
            font-size: 1.1rem;
        }
        
        .nav-menu a {
            font-size: 1rem;
            padding: 0.7rem 0.6rem;
        }
        
        .nav-container {
            padding: 0 3rem;
        }
    }

    /* Media queries para pantallas con poca altura */
    @media (max-height: 600px) {
        header {
            padding: 0.2rem 0;
        }
        
        .logo {
            max-width: 100px;
        }
        
        .mobile-slogan {
            font-size: 12px;
            margin: 3px 0 0 0;
        }
        
        .slogan {
            font-size: 14px;
        }
        
        .contact-info .phone-link {
            padding: 0.3rem 0.6rem;
            font-size: 0.9rem;
        }
        
        .nav-menu a {
            padding: 0.4rem 0.3rem;
            font-size: 0.8rem;
        }
        
        .header-content {
            gap: 0.3rem;
        }
    }

    /* Media queries para pantallas muy pequeñas en altura (landscape móvil) */
    @media (max-height: 500px) and (orientation: landscape) {
        header {
            padding: 0.1rem 0;
        }
        
        .logo {
            max-width: 80px;
        }
        
        .mobile-slogan {
            display: none; /* Ocultar en landscape muy pequeño */
        }
        
        .slogan {
            font-size: 12px;
        }
        
        .contact-info .phone-link {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .nav-menu a {
            padding: 0.3rem 0.2rem;
            font-size: 0.75rem;
        }
        
        .header-content {
            gap: 0.2rem;
        }
        
        .header-top,
        .header-middle {
            margin-bottom: 0.1rem;
        }
    }

    /* Estados scrolled responsivos */
    @media (max-width: 480px) {
        header.scrolled {
            padding: 0.15rem 0;
        }
        
        header.scrolled .logo {
            max-width: 70px;
        }
        
        .mobile-phone-link {
            font-size: 12px;
            padding: 6px 10px;
        }
        
        .menu-toggle {
            font-size: 1.2rem;
            padding: 0.3rem;
        }
    }

    /* Media queries para pantallas ultra anchas */
    @media (min-width: 1920px) {
        .nav-container {
            max-width: 1600px;
            padding: 0 4rem;
        }
        
        .logo {
            max-width: 180px;
        }
        
        .slogan {
            font-size: 20px;
        }
        
        .contact-info .phone-link {
            padding: 0.8rem 1.5rem;
            font-size: 1.2rem;
        }
        
        .nav-menu a {
            font-size: 1.1rem;
            padding: 0.8rem 0.7rem;
        }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Nuevas animaciones para el comportamiento de scroll */
    @keyframes slideInPhone {
        from { 
            opacity: 0; 
            transform: translateX(-50%) scale(0.8) translateY(-10px);
        }
        to { 
            opacity: 1; 
            transform: translateX(-50%) scale(0.95) translateY(0);
        }
    }
    
    @keyframes slideInToggle {
        from { 
            opacity: 0; 
            transform: scale(0.7) rotate(-90deg);
        }
        to { 
            opacity: 1; 
            transform: scale(0.9) rotate(0deg);
        }
    }
    
    @keyframes logoShrink {
        from { 
            max-width: 140px;
            transform: scale(1);
        }
        to { 
            max-width: 120px;
            transform: scale(0.95);
        }
    }
    
    @keyframes wrapperCollapse {
        from { 
            padding: 15px;
            transform: translateY(0);
        }
        to { 
            padding: 10px;
            transform: translateY(-5px);
        }
    }
    
    @keyframes containerCollapse {
        from { 
            padding: 0 1.5rem;
            transform: translateY(0);
        }
        to { 
            padding: 0 1rem;
            transform: translateY(-3px);
        }
    }
    
    @keyframes sloganFadeOut {
        from { 
            opacity: 1; 
            transform: translateY(0);
            height: auto;
        }
        to { 
            opacity: 0; 
            transform: translateY(-15px);
            height: 0;
        }
    }
    
    @keyframes headerContentCollapse {
        from {
            opacity: 1;
            transform: translateY(0);
            max-height: 100px;
        }
        to {
            opacity: 0;
            transform: translateY(-20px);
            max-height: 0;
        }
    }
    
    @keyframes slideInFromTop {
        from {
            opacity: 0;
            transform: translateY(-15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes logoExpand {
        from {
            transform: scale(0.9);
            opacity: 0.8;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    @keyframes navContainerExpand {
        from {
            height: auto;
            padding-bottom: 0;
        }
        to {
            height: auto;
            padding-bottom: 1.5rem;
        }
    }
    
    /* Dropdown Styles */
    .dropdown-container {
        position: relative;
    }
    
    .dropdown-toggle {
        align-items: center;
        gap: 0.3rem;
        position: relative;
        cursor: pointer;
        /* Mejorar soporte touch para iOS */
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
        touch-action: manipulation;
    }
    
    .dropdown-toggle:hover {
        text-decoration: none;
    }
    
    .dropdown-icon {
        font-size: 0.7rem;
        transition: transform 0.3s ease;
        pointer-events: none;
    }
    
    .dropdown-container:hover .dropdown-icon,
    .dropdown-container.active .dropdown-icon {
        transform: rotate(180deg);
    }
    
    .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        border: 2px solid rgba(202, 1, 1, 0.1);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        min-width: 300px;
        width: max-content;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1000;
        padding: 0.5rem 0;
        margin-top: 0.5rem;
        backdrop-filter: blur(10px);
    }
    
    .dropdown-container:hover .dropdown-menu,
    .dropdown-container.active .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(0);
    }
    
    .dropdown-menu li {
        list-style: none;
        margin: 0;
    }
    
        .dropdown-link {
            display: block;
            padding: 0.8rem 1.2rem;
            color: #333;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
            text-align: center;
        }
    
    .dropdown-link:hover {
        background: linear-gradient(135deg, rgba(202, 1, 1, 0.1) 0%, rgba(202, 1, 1, 0.05) 100%);
        color: #ca0101;
        border-left-color: #ca0101;
        transform: translateX(5px);
    }
    
    .dropdown-link::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #ca0101;
        transform: scaleY(0);
        transition: transform 0.3s ease;
    }
    
    .dropdown-link:hover::before {
        transform: scaleY(1);
    }
    
    /* Mobile dropdown styles */
    @media (max-width: 768px) {
        .dropdown-container {
            width: auto;
            margin: 0;
            text-align: center;
            display: inline-block;
        }
        
        .dropdown-toggle {
            width: auto;
            justify-content: center;
            padding: 0.6rem 0.5rem;
            background: none;
            border-radius: 4px;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: white;
            text-decoration: none;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            box-sizing: border-box;
            font-size: 0.9rem;
        }
        
        .dropdown-menu {
            position: static !important;
            margin: 0.5rem auto 0 auto;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
            opacity: 0;
            visibility: hidden;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(202, 1, 1, 0.2);
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            min-width: 0;
            width: 90%;
            max-width: 300px;
            display: block;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1001;
            min-height: 0;
            text-align: center;
        }
        
        .dropdown-container.active .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
            padding: 0.5rem 0 !important;
            max-height: 400px !important;
            min-height: auto !important;
            display: block !important;
            overflow: visible !important;
        }
        
        .dropdown-container.active .dropdown-icon {
            transform: rotate(180deg);
        }
        
        .dropdown-toggle:hover {
            color: var(--color-white);
            background-color: rgba(255, 255, 255, 0.1);
            text-decoration: none;
        }
        
        .dropdown-toggle.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: var(--color-white);
            font-weight: 700;
        }
        
        .dropdown-link {
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            border-left: none;
            border-bottom: 1px solid rgba(202, 1, 1, 0.1);
            text-align: center;
            font-weight: 600;
            display: block;
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .dropdown-link:hover {
            transform: none;
            background: linear-gradient(135deg, rgba(202, 1, 1, 0.1) 0%, rgba(202, 1, 1, 0.05) 100%);
            color: #ca0101;
        }
        
        .dropdown-link:last-child {
            border-bottom: none;
        }
        
        .dropdown-link:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }
        
        .dropdown-link:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        /* Asegurar que el dropdown sea visible en el menú móvil */
        .nav-menu.active .dropdown-menu {
            position: static !important;
            display: block !important;
            max-height: 0 !important;
            overflow: hidden !important;
        }
        
        .nav-menu.active .dropdown-container.active .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            padding: 0.5rem 0 !important;
            max-height: 400px !important;
            min-height: auto !important;
            overflow: visible !important;
        }
        
        /* Expandir el nav-container cuando el dropdown está activo en móvil */
        .nav-container {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .nav-menu.active .dropdown-container.active ~ * {
            margin-top: 0.5rem;
        }
        
        /* Asegurar que el nav-container se expanda para acomodar el dropdown */
        .nav-menu.active .dropdown-container.active {
            margin-bottom: 1rem;
        }
        
        /* Hacer que el nav-container sea más alto cuando el dropdown está activo */
        .nav-menu.active .dropdown-container.active .nav-container {
            min-height: auto;
            padding-bottom: 1rem;
        }
        
        /* Expandir el header cuando el dropdown está activo en móvil */
        .nav-menu.active .dropdown-container.active header {
            min-height: auto;
        }
        
        /* Asegurar que el header-content se expanda */
        .nav-menu.active .dropdown-container.active .header-content {
            min-height: auto;
        }
        
        /* Expandir el header-bottom para acomodar el dropdown */
        .nav-menu.active .dropdown-container.active .header-bottom {
            min-height: auto;
            padding-bottom: 1rem;
        }
        
        /* Hacer que el nav-menu sea más largo cuando el dropdown está desplegado */
        .nav-menu.active .dropdown-container.active {
            max-height: 600px !important;
        }
        
        /* Expandir el nav-menu específicamente cuando el dropdown está activo */
        .nav-menu.active.dropdown-expanded {
            max-height: 600px !important;
            padding-bottom: 1.5rem !important;
        }
        
        /* Asegurar que el nav-menu tenga suficiente espacio */
        .nav-menu.active .dropdown-container.active .nav-menu {
            max-height: 600px !important;
        }
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
            max-height: 0;
            padding: 0 0;
        }
        to {
            opacity: 1;
            transform: translateY(0);
            max-height: 400px;
            padding: 0.5rem 0;
        }
    }
    
    /* Tablet dropdown adjustments */
    @media (min-width: 769px) and (max-width: 1024px) {
        .dropdown-menu {
            min-width: 280px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .dropdown-container:hover .dropdown-menu {
            transform: translateX(-50%) translateY(0);
        }
        
        .dropdown-link {
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
            text-align: center;
        }
    }
    
    /* Desktop dropdown adjustments */
    @media (min-width: 1025px) and (max-width: 1440px) {
        .dropdown-menu {
            min-width: 320px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .dropdown-container:hover .dropdown-menu {
            transform: translateX(-50%) translateY(0);
        }
        
        .dropdown-link {
            padding: 0.9rem 1.4rem;
            font-size: 0.95rem;
            text-align: center;
        }
    }
    
    /* Extra large screens */
    @media (min-width: 1441px) {
        .dropdown-menu {
            min-width: 350px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .dropdown-container:hover .dropdown-menu {
            transform: translateX(-50%) translateY(0);
        }
        
        .dropdown-link {
            padding: 1rem 1.6rem;
            font-size: 1rem;
            text-align: center;
        }
    }
    
    /* Mobile small screens (≤480px) */
    @media (max-width: 480px) {
        .dropdown-container {
            margin: 0.3rem 0;
            text-align: center;
            width: auto;
            display: inline-block;
        }
        
        .dropdown-toggle {
            padding: 0.5rem 0.3rem;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            text-align: center;
            width: auto;
            background: none;
            border-radius: 4px;
            margin-bottom: 0;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            box-sizing: border-box;
        }
        
        .dropdown-menu {
            position: static !important;
            margin: 0.5rem auto 0 auto;
            left: 0 !important;
            right: 0 !important;
            transform: none !important;
            max-width: 95vw;
            width: 95vw;
            border-radius: 10px;
            opacity: 0;
            visibility: hidden;
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dropdown-container.active .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: none !important;
            max-height: 400px !important;
            min-height: auto !important;
            display: block !important;
            overflow: visible !important;
        }
        
        .dropdown-link {
            padding: 0.7rem 1rem;
            font-size: 0.85rem;
            display: block;
        }
    }
    
    /* Mobile extra small screens (≤360px) */
    @media (max-width: 360px) {
        .dropdown-container {
            margin: 0.2rem 0;
            text-align: center;
            width: auto;
            display: inline-block;
        }
        
        .dropdown-toggle {
            padding: 0.3rem 0.2rem;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            text-align: center;
            width: auto;
            background: none;
            border-radius: 4px;
            margin-bottom: 0;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            box-sizing: border-box;
        }
        
        .dropdown-menu {
            max-width: 260px;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            max-height: 0;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dropdown-container.active .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
            max-height: 400px !important;
            min-height: auto !important;
            display: block !important;
            overflow: visible !important;
        }
        
        .dropdown-link {
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
            display: block;
        }
    }
    
    /* Estilos específicos para dispositivos táctiles (iOS Safari) */
    @media (hover: none) and (pointer: coarse) {
        .dropdown-toggle {
            -webkit-tap-highlight-color: rgba(202, 1, 1, 0.3);
            tap-highlight-color: rgba(202, 1, 1, 0.3);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            min-height: 44px; /* iOS recomendado para touch targets */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .dropdown-container .dropdown-menu {
            /* Asegurar que el dropdown sea visible en touch */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .dropdown-container.active .dropdown-menu {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateX(-50%) translateY(0) !important;
        }
        
        /* Mejorar el área táctil en móvil */
        @media (max-width: 768px) {
            .dropdown-toggle {
                padding: 0.8rem 1rem;
                min-height: 48px;
                font-size: 1rem;
            }
            
            .dropdown-menu {
                position: static;
                transform: none;
                width: 100%;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                border-radius: 8px;
                margin: 0.5rem 0;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease, padding 0.3s ease;
                padding: 0;
            }
            
            .dropdown-container.active .dropdown-menu {
                max-height: 300px;
                padding: 0.5rem 0;
            }
            
            .dropdown-link {
                padding: 1rem 1.5rem;
                font-size: 0.95rem;
                border-bottom: 1px solid rgba(0,0,0,0.05);
            }
            
            .dropdown-link:last-child {
                border-bottom: none;
            }
        }
    }
    
    /* Ultra-wide screens */
    @media (min-width: 1920px) {
        .dropdown-menu {
            min-width: 380px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
        }
        
        .dropdown-container:hover .dropdown-menu {
            transform: translateX(-50%) translateY(0);
        }
        
        .dropdown-link {
            padding: 1.1rem 1.8rem;
            font-size: 1.1rem;
            text-align: center;
        }
    }
</style>

<script>
    // Mobile menu toggle functionality
    document.addEventListener('DOMContentLoaded', () => {
        const menuToggle = document.getElementById('menu-toggle');
        const navMenu = document.getElementById('nav-menu');
        
        if (menuToggle && navMenu) {
            menuToggle.addEventListener('click', () => {
                navMenu.classList.toggle('active');
                // Change icon based on menu state
                const icon = menuToggle.querySelector('i');
                if (icon) {
                    if (navMenu.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                }
            });
            
            // Close menu when clicking on links
            const menuLinks = navMenu.querySelectorAll('a');
            menuLinks.forEach(link => {
                link.addEventListener('click', () => {
                    navMenu.classList.remove('active');
                    const icon = menuToggle.querySelector('i');
                    if (icon) {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            });
        }
        
        // Dropdown functionality
        const dropdownContainer = document.querySelector('.dropdown-container');
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        
        if (dropdownContainer && dropdownToggle) {
            let touchStarted = false;
            
            // Desktop hover functionality
            dropdownContainer.addEventListener('mouseenter', () => {
                if (window.innerWidth > 768 && !touchStarted) {
                    dropdownContainer.classList.add('active');
                }
            });
            
            dropdownContainer.addEventListener('mouseleave', () => {
                if (window.innerWidth > 768 && !touchStarted) {
                    dropdownContainer.classList.remove('active');
                }
            });
            
            // Touch events para dispositivos móviles (especialmente iOS)
            dropdownToggle.addEventListener('touchstart', (e) => {
                touchStarted = true;
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle dropdown
                dropdownContainer.classList.toggle('active');
                
                // Para mobile, asegurar que el nav menu se mantenga abierto
                if (window.innerWidth <= 768) {
                    const navMenu = document.getElementById('nav-menu');
                    if (navMenu) {
                        navMenu.classList.add('active');
                        if (dropdownContainer.classList.contains('active')) {
                            navMenu.classList.add('dropdown-expanded');
                        } else {
                            navMenu.classList.remove('dropdown-expanded');
                        }
                    }
                }
                
                // Reset touch flag after a delay
                setTimeout(() => { touchStarted = false; }, 300);
            });
            
            // Click functionality para desktop y como fallback
            dropdownToggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Si ya se manejó con touch, no procesar el click
                if (touchStarted) {
                    return;
                }
                
                // Toggle dropdown
                dropdownContainer.classList.toggle('active');
                
                // Para mobile, asegurar que el nav menu se mantenga abierto
                if (window.innerWidth <= 768) {
                    const navMenu = document.getElementById('nav-menu');
                    if (navMenu) {
                        navMenu.classList.add('active');
                        if (dropdownContainer.classList.contains('active')) {
                            navMenu.classList.add('dropdown-expanded');
                        } else {
                            navMenu.classList.remove('dropdown-expanded');
                        }
                    }
                }
            });
            
            // Close dropdown when clicking/touching outside
            document.addEventListener('click', (e) => {
                if (!dropdownContainer.contains(e.target as Node) && 
                    dropdownContainer.classList.contains('active')) {
                    dropdownContainer.classList.remove('active');
                    
                    // Remove dropdown-expanded class from nav-menu
                    const navMenu = document.getElementById('nav-menu');
                    if (navMenu) {
                        navMenu.classList.remove('dropdown-expanded');
                    }
                }
            });
            
            // Close dropdown when touching outside (iOS specific)
            document.addEventListener('touchstart', (e) => {
                if (!dropdownContainer.contains(e.target as Node) && 
                    dropdownContainer.classList.contains('active')) {
                    dropdownContainer.classList.remove('active');
                    
                    // Remove dropdown-expanded class from nav-menu
                    const navMenu = document.getElementById('nav-menu');
                    if (navMenu) {
                        navMenu.classList.remove('dropdown-expanded');
                    }
                }
            });
            
            // Close dropdown when clicking on dropdown links
            const dropdownLinks = dropdownContainer.querySelectorAll('.dropdown-link');
            dropdownLinks.forEach(link => {
                link.addEventListener('click', () => {
                    dropdownContainer.classList.remove('active');
                    
                    // Remove dropdown-expanded class from nav-menu
                    const navMenu = document.getElementById('nav-menu');
                    if (navMenu) {
                        navMenu.classList.remove('dropdown-expanded');
                    }
                    
                    // For mobile, close the entire nav menu after clicking a dropdown link
                    if (window.innerWidth <= 768) {
                        const menuToggle = document.getElementById('menu-toggle');
                        if (navMenu) {
                            navMenu.classList.remove('active');
                        }
                        if (menuToggle) {
                            const icon = menuToggle.querySelector('i');
                            if (icon) {
                                icon.classList.remove('fa-times');
                                icon.classList.add('fa-bars');
                            }
                        }
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth > 768) {
                    dropdownContainer.classList.remove('active');
                }
            });
            
            // Prevent dropdown from closing when clicking inside it
            dropdownContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Active tab functionality
        const navLinks = document.querySelectorAll('.nav-link');
        
        // Function to set active tab based on current URL
        function setActiveTab() {
            const currentPath = window.location.pathname;
            let currentSection = 'inicio';
            
            if (currentPath === '/') {
                currentSection = 'inicio';
            } else if (currentPath.startsWith('/servicios') || currentPath.startsWith('/serviciosanticipado') || currentPath.startsWith('/serviciosaccionlegal')) {
                currentSection = 'servicios';
            } else if (currentPath.startsWith('/quienes-somos')) {
                currentSection = 'quienes-somos';
            } else if (currentPath.startsWith('/faq')) {
                currentSection = 'faq';
            } else if (currentPath.startsWith('/trabaja-con-nosotros')) {
                currentSection = 'trabaja-con-nosotros';
            }
            
            // Update active tab
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === currentSection) {
                    link.classList.add('active');
                }
            });
        }
        
        // Header scroll effect
        function handleHeaderScroll() {
            const header = document.querySelector('header');
            if (header) {
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            }
        }

        // Smooth scroll to section with snap behavior
        function smoothScrollToSection(sectionId) {
            const section = document.querySelector(`#${sectionId}`);
            if (section) {
                const targetPosition = section.offsetTop;
                
                window.scrollTo({
                    top: targetPosition,
                    behavior: 'smooth'
                });
            }
        }

        // Auto-navigation based on scroll direction and position
        let lastScrollTop = 0;
        let scrollTimeout;
        
        function handleSmartScroll() {
            const currentScrollTop = window.scrollY;
            const scrollDirection = currentScrollTop > lastScrollTop ? 'down' : 'up';
            const scrollDistance = Math.abs(currentScrollTop - lastScrollTop);
            
            // Only trigger auto-navigation for significant scrolls
            if (scrollDistance > 30) {
                clearTimeout(scrollTimeout);
                
                scrollTimeout = setTimeout(() => {
                    const sections = document.querySelectorAll('section[id]');
                    const currentPosition = currentScrollTop + 50;
                    
                    let targetSection = null;
                    
                    if (scrollDirection === 'down') {
                        // Find next section
                        for (let i = 0; i < sections.length; i++) {
                            if (sections[i].offsetTop > currentPosition) {
                                targetSection = sections[i];
                                break;
                            }
                        }
                    } else {
                        // Find previous section
                        for (let i = sections.length - 1; i >= 0; i--) {
                            if (sections[i].offsetTop < currentPosition) {
                                targetSection = sections[i];
                                break;
                            }
                        }
                    }
                    
                    // Auto-scroll to target section if found
                    if (targetSection && scrollDistance > 50) {
                        const targetId = targetSection.getAttribute('id');
                        smoothScrollToSection(targetId);
                    }
                }, 100); // Reduced delay for more responsive navigation
            }
            
            lastScrollTop = currentScrollTop;
        }
        
        // Update scroll indicator
        function updateScrollIndicator() {
            const scrollDots = document.querySelectorAll('.scroll-dot');
            const scrollPosition = window.scrollY + 100;
            
            scrollDots.forEach(dot => {
                const sectionId = dot.getAttribute('data-section');
                const section = document.querySelector(`#${sectionId}`);
                
                if (section) {
                    const sectionTop = section.offsetTop;
                    const sectionBottom = sectionTop + section.offsetHeight;
                    
                    if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                }
            });
        }

        // Handle scroll dot clicks
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('scroll-dot')) {
                const sectionId = e.target.getAttribute('data-section');
                smoothScrollToSection(sectionId);
            }
        });
        
        // Set active tab on scroll and navigation
        window.addEventListener('scroll', () => {
            handleHeaderScroll();
            handleSmartScroll();
            updateScrollIndicator();
        });
        
        // Listen for navigation changes (for SPA-like behavior)
        window.addEventListener('popstate', () => {
            setActiveTab();
        });
        
        // Set initial active tab and header state
        setActiveTab();
        handleHeaderScroll();
        updateScrollIndicator();
        
        // Set active tab on click and update based on navigation
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                // Remove active class from all links
                navLinks.forEach(l => l.classList.remove('active'));
                // Add active class to clicked link
                link.classList.add('active');
                
                // Update active tab based on the new URL after navigation
                setTimeout(() => {
                    setActiveTab();
                }, 100);
            });
        });
    });
</script>
